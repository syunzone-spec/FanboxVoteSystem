<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·®åˆ†ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</title>
    
    <meta property="og:title" content="å·®åˆ†ãƒªã‚¯ã‚¨ã‚¹ãƒˆ">
    <meta property="og:description" content="ã‚¤ãƒ©ã‚¹ãƒˆã®å·®åˆ†ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; color: #333; background-color: #f4f7f6; line-height: 1.6; }
        h2 { color: #28a745; margin-bottom: 20px; }
        .box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left; }
        .login-box { border-top: 5px solid #ffc107; text-align: center; }
        .req-box { border-top: 5px solid #28a745; }
        
        label { display: block; font-weight: bold; margin-bottom: 5px; margin-top: 10px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        
        button { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .hidden { display: none; }
        .error-msg { color: #dc3545; background: #ffe6e6; padding: 10px; border-radius: 4px; margin-top: 10px; display:none; }
        .logout-link { display: block; margin-top: 30px; font-size: 0.85em; color: #999; text-decoration: underline; cursor: pointer; text-align: center; }
    </style>
</head>
<body>

    <h2>ğŸ—³ï¸ å·®åˆ†ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h2>

    <div id="login-section" class="box login-box">
        <h3>æ”¯æ´è€…èªè¨¼</h3>
        <p style="font-size:0.9em; color:#666;">Fanboxã®æ”¯æ´è€…IDã¨åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        <input type="number" id="pixiv-id" placeholder="Pixiv ID (æ•°å­—)">
        <input type="text" id="pixiv-name" placeholder="Pixivãƒ¦ãƒ¼ã‚¶ãƒ¼å">
        <input type="text" id="monthly-pass" placeholder="ä»Šæœˆã®åˆè¨€è‘‰">
        <button id="login-btn" style="background-color:#ffc107; color:#333;">èªè¨¼ã—ã¦é€²ã‚€</button>
        <div id="login-error" class="error-msg"></div>
    </div>

    <div id="main-area" class="hidden">
        <div class="box req-box">
            <h3>æ–°ã—ã„æ¡ˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h3>
            <p style="font-size:0.85em; color:#666;">ã»ã¼æ›¸ãç›´ã—ãŒå¿…è¦ãªã©ã€<BR>å¯¾å¿œãŒé›£ã—ã„ç‰©ã¯åæ˜ ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚</p>
            <p>æœŸé–“ä¸­ã«åŒä¸€HNã‹ã‚‰è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã£ãŸå ´åˆã€<span class="important">æœ€å¾Œã«é€ä¿¡ã•ã‚ŒãŸå†…å®¹ã®ã¿ã‚’æœ‰åŠ¹ï¼ˆå¾Œå‹ã¡ï¼‰</span>ã¨ã—ã¾ã™ã€‚ä¿®æ­£ã—ãŸã„å ´åˆã¯å†åº¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
            
            <h3>ğŸ“ å·®åˆ†ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h3>
            
            <!--
            <label>å¯¾è±¡ã‚¤ãƒ©ã‚¹ãƒˆï¼ˆãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠï¼šè©¦é¨“é‹ç”¨ã®ãŸã‚ã€ç¾åœ¨å›ºå®šã§ã™ã€‚ï¼‰</label>
            <select id="req-subject">
                <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
            </select>
	ã€€ã€€-->

	    <label>å¯¾è±¡ã‚¤ãƒ©ã‚¹ãƒˆ</label>
            <input type="text" id="req-subject" placeholder="ä¾‹: 2025å¹´6æœˆæŠ•ç¨¿ã®ãƒãƒªã‚¢ ãªã©" maxlength="30">

            <label>å·®åˆ†å†…å®¹ï¼ˆ50æ–‡å­—ä»¥å†…ï¼‰</label>
            <input type="text" id="req-content" maxlength="50" placeholder="ä¾‹: èƒ¸éœ²å‡ºã€é¼»ãƒ•ãƒƒã‚¯ã€ã‚¢ãƒ˜é¡”ã€ã¶ã£ã‹ã‘ ç­‰">
            
            <button id="req-submit-btn" class="btn-green">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ç¨¿</button>

        </div>
        <div class="logout-link" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
    </div>

    <script>
        // â˜…GAS URL
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzNarCkSJAZ4EcFLzKJESySKByFFsa-pAk2fDLZ-twdbIuKaqhDlnHwSZ7bkIoX1BCy6A/exec";

        document.addEventListener('DOMContentLoaded', () => {
            getOrCreateUUID();
            const pid = localStorage.getItem('supporter_pid');
            const pass = localStorage.getItem('supporter_pass');
            const name = localStorage.getItem('supporter_name');
            if(pid && pass) {
                document.getElementById('pixiv-id').value = pid;
                document.getElementById('monthly-pass').value = pass;
                if(name) document.getElementById('pixiv-name').value = name;
                doLogin(pid, pass, name);
            }
        });

        document.getElementById('login-btn').onclick = () => {
            const pid = document.getElementById('pixiv-id').value;
            const pass = document.getElementById('monthly-pass').value;
            const name = document.getElementById('pixiv-name').value;
            if(!pid || !pass) return alert("IDã¨åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            doLogin(pid, pass, name);
        };

        async function doLogin(pid, pass, name) {
            const btn = document.getElementById('login-btn');
            btn.disabled = true; btn.innerText = "èªè¨¼ä¸­...";
            try {
                localStorage.setItem('supporter_pid', pid);
                localStorage.setItem('supporter_pass', pass);
                if(name) localStorage.setItem('supporter_name', name);

                const res = await fetch(`${GAS_API_URL}?mode=variant_init&pixiv_id=${pid}&password=${encodeURIComponent(pass)}`);
                const json = await res.json();

                if(json.status === 'success') {
                    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ
		   /*
                    const sel = document.getElementById('req-subject');
                    sel.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';
                    json.data.subjects.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s; opt.innerText = s; sel.appendChild(opt);
                    });
                    */
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('main-area').classList.remove('hidden');
		} else if (json.status === 'maintenance') {
		   // ç”»é¢å…¨ä½“ã‚’ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¡¨ç¤ºã«æ›¸ãæ›ãˆ
		   document.body.innerHTML = `
		       <div style="text-align:center; padding:50px; font-family:sans-serif;">
		           <h2 style="color:#ffc107;">ğŸš§ MAINTENANCE</h2>
		           <p>${json.message.replace(/\n/g, '<br>')}</p>
		       </div>`;
		   return;
		} else {
                    alert(json.message);
                    if(json.message.includes('èªè¨¼')) localStorage.removeItem('supporter_pass');
                }
            } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); } finally { btn.disabled = false; btn.innerText = "èªè¨¼ã—ã¦é€²ã‚€"; }
        }

        document.getElementById('req-submit-btn').onclick = async () => {
            const subject = document.getElementById('req-subject').value;
            const content = document.getElementById('req-content').value;
            if(!subject || !content) return alert("å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
            if(!confirm("ã“ã®å†…å®¹ã§é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n(é€ä¿¡å¾Œã¯æ‰¿èªå¾…ã¡ã¨ãªã‚Šã¾ã™)")) return;

            const btn = document.getElementById('req-submit-btn');
            btn.disabled = true; btn.innerText = "é€ä¿¡ä¸­...";

            try {
                const ip = await getIpAddress();
                const payload = {
                    action: 'submit_variant_request',
                    pixiv_id: localStorage.getItem('supporter_pid'),
                    password: localStorage.getItem('supporter_pass'),
                    nickname: localStorage.getItem('supporter_name') || 'åç„¡ã—',
                    subject: subject,
                    content: content,
                    ip_address: ip,
                    user_agent: navigator.userAgent,
                    device_uuid: getOrCreateUUID(),
                    screen_info: `${window.screen.width}x${window.screen.height}`
                };
                const res = await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if(json.status === 'success') {
                    alert("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼\nç®¡ç†è€…ã®ç¢ºèªå¾Œã«ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚");
                    document.getElementById('req-content').value = "";
                } else {
                    alert("ã‚¨ãƒ©ãƒ¼: " + json.message);
                }
            } catch(e) { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); } finally { btn.disabled = false; btn.innerText = "ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡"; }
        };

        async function getIpAddress() { try { const r = await fetch('https://api.ipify.org?format=json'); return (await r.json()).ip; } catch { return "unknown"; } }
        function getOrCreateUUID() {
            const KEY = 'gacha_device_uuid';
            let u = localStorage.getItem(KEY);
            if (!u) { u = crypto.randomUUID(); localStorage.setItem(KEY, u); } return u;
        }
        function logout() { if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
