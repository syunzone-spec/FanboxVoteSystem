<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€æ”¯æ´è€…é™å®šã€‘æŠ•ç¥¨æ‰€</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; color: #333; background: #fffaf0; }
        
        .top-link { margin-bottom: 20px; }
        .top-link a { color: #ff9900; text-decoration: none; font-weight: bold; border: 1px solid #ff9900; padding: 8px 15px; border-radius: 20px; background: white; }
        
        .login-box, .gacha-box, .list-box { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffcc00; }
        .hidden { display: none; }
        
        .status-badge { background: #ffcc00; color: #333; padding: 5px 10px; border-radius: 15px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        
        /* ã‚¬ãƒãƒ£æ¼”å‡º */
        .gacha-ball { width: 80px; height: 80px; line-height: 80px; border-radius: 50%; font-weight: bold; color: white; margin: 20px auto; font-size: 2em; box-shadow: 0 4px 10px rgba(0,0,0,0.3); animation: pop 0.5s ease-out; }
        .ball-SSR { background: gold; border: 4px solid orange; color: #a05a00; }
        .ball-SR { background: silver; border: 4px solid gray; color: #333; }
        .ball-R { background: #cd7f32; border: 4px solid #8b4513; color: white; }
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        input { padding: 10px; font-size: 1.2em; width: 80%; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #ff9900; color: white; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .candidate-card { border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .vote-btn { background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; }

        /* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ï¼ˆæ§ãˆã‚ã«é…ç½®ï¼‰ */
        .logout-link { display: block; margin-top: 10px; font-size: 0.8em; color: #999; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸ—³ï¸ æ”¯æ´è€…é™å®šæŠ•ç¥¨æ‰€</h2>
    
    <div class="top-link">
        <a href="result.html" target="_blank">ğŸ“Š ç¾åœ¨ã®é †ä½ã‚’ç¢ºèªã™ã‚‹</a>
    </div>

    <div id="login-section" class="login-box">
        <p>Pixiv IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="number" id="pixiv-id" placeholder="Pixiv ID">
        <br>
        <button id="check-btn">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦çŠ¶æ…‹ç¢ºèª</button>
    </div>

    <div id="loading-msg" class="hidden" style="margin-bottom:20px; color:#666;">
        èªè¨¼ä¸­...
    </div>

    <div id="vote-section" class="gacha-box hidden">
        <div class="status-badge">æ®‹ã‚ŠæŠ•ç¥¨å›æ•°: <span id="remain-count">0</span> / <span id="max-count">0</span></div>
        
        <p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ä»Šå›ã®ç¥¨æ•°ã‚’æ±ºå®šã—ã¾ã™ã€‚</p>
        <button id="pull-btn">æŠ½é¸é–‹å§‹</button>

        <div id="result-area" class="hidden">
            <div id="gacha-ball-display"></div>
            <p style="font-size:1.2em;">ä»Šå›ã¯ <strong><span id="current-weight" style="color:red; font-size:1.5em;"></span> ç¥¨</strong> ã¨ã—ã¦æŠ•ç¥¨ã§ãã¾ã™ï¼</p>
            <hr>
            <p>æŠ•ç¥¨å…ˆã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆãƒªã‚¹ãƒˆã¯ãƒ©ãƒ³ãƒ€ãƒ é †ï¼‰</p>
            <div id="candidates-list"></div>
        </div>

        <div class="logout-link" onclick="logout()">IDã‚’å¤‰æ›´ã™ã‚‹ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰</div>
    </div>

    <div id="done-section" class="list-box hidden">
        <h3>ğŸ‰ æŠ•ç¥¨å®Œäº† ğŸ‰</h3>
        <p>ä»Šå›ã®æŠ•ç¥¨æ¨©ã‚’ã™ã¹ã¦ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸï¼<br>ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼</p>
        <button onclick="location.href='result.html'">çµæœã‚’è¦‹ã‚‹</button>
        
        <div class="logout-link" onclick="logout()">IDã‚’å¤‰æ›´ã™ã‚‹ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰</div>
    </div>

    <script>
        // â˜…GAS URLâ˜…
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzNarCkSJAZ4EcFLzKJESySKByFFsa-pAk2fDLZ-twdbIuKaqhDlnHwSZ7bkIoX1BCy6A/exec";
        let currentUser = null;
        let candidatesData = [];

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã¿ã‚‹
        document.addEventListener('DOMContentLoaded', () => {
            const savedId = localStorage.getItem('supporter_pid');
            if(savedId) {
                // IDãŒã‚ã‚Œã°è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
                document.getElementById('pixiv-id').value = savedId;
                performLogin(savedId);
            }
        });

        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('check-btn').addEventListener('click', () => {
            const pid = document.getElementById('pixiv-id').value;
            if(!pid) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            performLogin(pid);
        });

        // å…±é€šãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function performLogin(pid) {
            const loginBox = document.getElementById('login-section');
            const loadingMsg = document.getElementById('loading-msg');
            const btn = document.getElementById('check-btn');

            // UIæ“ä½œ: ãƒ­ã‚°ã‚¤ãƒ³çª“ã‚’éš ã—ã¦ã€Œèªè¨¼ä¸­ã€ã‚’å‡ºã™
            loginBox.classList.add('hidden');
            loadingMsg.classList.remove('hidden');
            btn.disabled = true;

            try {
                // ä¿å­˜
                localStorage.setItem('supporter_pid', pid);
                
                const res = await fetch(`${GAS_API_URL}?pixiv_id=${pid}`);
                const json = await res.json();
                
                loadingMsg.classList.add('hidden'); // èªè¨¼ä¸­ã‚’æ¶ˆã™

                if(json.status === 'success') {
                    currentUser = json.data.user;
                    candidatesData = json.data.candidates;
                    
                    if (currentUser.is_fully_voted) {
                        // å®Œäº†æ¸ˆã¿
                        document.getElementById('done-section').classList.remove('hidden');
                    } else {
                        // æŠ•ç¥¨å¯èƒ½
                        setupVoteScreen();
                    }
                } else {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ï¼ˆIDé–“é•ã„ãªã©ï¼‰ã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã™
                    alert(json.message);
                    loginBox.classList.remove('hidden');
                    btn.disabled = false;
                    // é–“é•ã„ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ¶ˆã—ã¦ãŠã
                    localStorage.removeItem('supporter_pid'); 
                }
            } catch(e) {
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                loadingMsg.classList.add('hidden');
                loginBox.classList.remove('hidden');
                btn.disabled = false;
            }
        }

        function setupVoteScreen() {
            const remain = currentUser.max_votes - currentUser.vote_count;
            document.getElementById('remain-count').innerText = remain;
            document.getElementById('max-count').innerText = currentUser.max_votes; // åˆ†æ¯
            document.getElementById('vote-section').classList.remove('hidden');
            
            // ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³è¨­å®š
            document.getElementById('pull-btn').onclick = () => {
                playGacha(currentUser.next_gacha);
            };
        }

        function playGacha(result) {
            document.getElementById('pull-btn').classList.add('hidden'); 
            const area = document.getElementById('result-area');
            area.classList.remove('hidden');
            
            const ball = document.getElementById('gacha-ball-display');
            ball.className = `gacha-ball ball-${result.rank}`;
            ball.innerText = result.rank;
            
            document.getElementById('current-weight').innerText = result.weight;

            const shuffled = shuffleArray([...candidatesData]);
            renderList(shuffled, result.weight);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderList(list, weight) {
            const container = document.getElementById('candidates-list');
            container.innerHTML = "";
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'candidate-card';
                div.innerHTML = `
                    <div style="text-align:left;"><strong>${item.character}</strong><br><small>${item.theme}</small></div>
                    <button class="vote-btn" onclick="submitVote('${item.id}', '${item.character}', ${weight})">æŠ•ç¥¨</button>
                `;
                container.appendChild(div);
            });
        }

        async function submitVote(targetId, charName, weight) {
            if(!confirm(`ã€Œ${charName}ã€ã« ${weight}ç¥¨ ã‚’æŠ•ç¥¨ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            
            const allBtns = document.querySelectorAll('.vote-btn');
            allBtns.forEach(b => b.disabled = true);

            try {
                const payload = {
                    action: 'submit_vote_supporter',
                    pixiv_id: currentUser.pixiv_id,
                    target_request_id: targetId,
                    total_weight: weight, // â€»GASå´ã®å¤‰æ•°åã«åˆã‚ã›ã¦é€ã‚‹ï¼ˆã“ã“ã¯ä»¥å‰ã®ã¾ã¾ã§OKï¼‰
                    ip_address: await getIp(),
                    user_agent: navigator.userAgent
                };
                
                const res = await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                
                if(json.status === 'success') {
                    alert("æŠ•ç¥¨å®Œäº†ï¼\n(æ¬¡ã®æŠ•ç¥¨ã¸é€²ã¿ã¾ã™)");
                    location.reload(); 
                } else {
                    alert(json.message);
                    location.reload();
                }
            } catch(e) { 
                alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); 
                location.reload(); 
            }
        }
        
        async function getIp() { try { const r = await fetch('https://api.ipify.org?format=json'); return (await r.json()).ip; } catch { return ''; } }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆæ¬¡å›IDå…¥åŠ›ãŒå¿…è¦ã«ãªã‚Šã¾ã™ï¼‰")) {
                localStorage.removeItem('supporter_pid');
                location.reload();
            }
        }
    </script>
</body>
</html>
