<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¯ã‚¨ã‚¹ãƒˆæŠ•ç¥¨æ‰€</title>
    <meta property="og:title" content="ãƒªã‚¯ã‚¨ã‚¹ãƒˆæŠ•ç¥¨æ‰€">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://syunzone-spec.github.io/FanboxVoteSystem/vote_public.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://syunzone-spec.github.io/FanboxVoteSystem/vote_public.png">
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; color: #333; }
        .top-link { margin-bottom: 20px; }
        .top-link a { color: #007bff; text-decoration: none; font-weight: bold; border: 1px solid #007bff; padding: 8px 15px; border-radius: 20px; }
        .top-link a:hover { background: #f0f8ff; }
        
        .candidate-card { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; text-align: left; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .vote-btn { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .vote-btn:disabled { background: #ccc; }
        .notice { background: #e2f0ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; font-size: 0.9em; }
    </style>
</head>
<body>
    <h2>ä¸€èˆ¬æŠ•ç¥¨æ‰€</h2>
    
    <div class="top-link">
        <a href="result.html" target="_blank">ğŸ“Š ç¾åœ¨ã®é †ä½ã‚’ç¢ºèªã™ã‚‹</a>
    </div>

    <div class="notice">
        <p>ã©ãªãŸã§ã‚‚1æ—¥1å›æŠ•ç¥¨å¯èƒ½ã§ã™ï¼ï¼ˆ1ç¥¨ï¼‰</p>
        <p>ğŸ—³ï¸ æŠ•ç¥¨æœŸé–“ï¼š2026å¹´1æœˆ20æ—¥ï½2026å¹´1æœˆ31æ—¥</p>
	<hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">
        <p style="color: #d9534f; font-size: 0.9em; font-weight: bold;">
            ã€ã”æ³¨æ„ã€‘<br>
            å…¬å¹³æ€§ã‚’ä¿ã¤ãŸã‚ã€ä¸è‡ªç„¶ãªé€£ç¶šæŠ•ç¥¨ã‚„ä¸æ­£ã¨æ¤œçŸ¥ã—ãŸç¥¨ã¯<BR>é›†è¨ˆæ™‚ã«ç„¡åŠ¹ã¨ã•ã›ã¦ã„ãŸã ãå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
        </p>
    </div>

    <div id="candidates-list">èª­ã¿è¾¼ã¿ä¸­...</div>

    <script>
        // â˜…GAS URLâ˜…
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzNarCkSJAZ4EcFLzKJESySKByFFsa-pAk2fDLZ-twdbIuKaqhDlnHwSZ7bkIoX1BCy6A/exec";

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch(`${GAS_API_URL}?mode=public_vote`);
                const json = await res.json();
                
                // ãƒªã‚¹ãƒˆã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ã‹ã‚‰è¡¨ç¤º
                const shuffled = shuffleArray(json.data.candidates);
                renderCandidates(shuffled);
            } catch(e) {
                document.getElementById('candidates-list').innerText = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
            }
        });

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•° (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderCandidates(list) {
            const container = document.getElementById('candidates-list');
            container.innerHTML = "";
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'candidate-card';
                div.innerHTML = `
                    <div><strong>${item.character}</strong><br><small>${item.theme}</small></div>
                    <button class="vote-btn" onclick="vote('${item.id}', '${item.character}')">æŠ•ç¥¨ (1pt)</button>
                `;
                container.appendChild(div);
            });
        }

        async function vote(targetId, charName) {
            if(!confirm(`ã€Œ${charName}ã€ã«æŠ•ç¥¨ã—ã¾ã™ã‹ï¼Ÿ(1ç¥¨)`)) return;
            const btns = document.querySelectorAll('.vote-btn');
            btns.forEach(b => b.disabled = true);
            
            try {
                const ip = await getIp();
                const payload = {
                    action: 'submit_vote_public',
                    target_request_id: targetId,
                    ip_address: ip,
                    user_agent: navigator.userAgent,
                    screen_info: `${window.screen.width}x${window.screen.height}`,
                    device_uuid: getUUID()
                };
                
                const res = await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                
                if (json.status === 'success') {
                    alert("æŠ•ç¥¨ã—ã¾ã—ãŸï¼");
                    location.href = 'result.html'; 
                } else {
                    alert(json.message);
                    btns.forEach(b => b.disabled = false);
                }
            } catch(e) {
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
                btns.forEach(b => b.disabled = false);
            }
        }

        async function getIp() { try { const r = await fetch('https://api.ipify.org?format=json'); return (await r.json()).ip; } catch { return ''; } }
        function getUUID() {
            let u = localStorage.getItem('g_uuid');
            if(!u) { u = crypto.randomUUID(); localStorage.setItem('g_uuid', u); }
            return u;
        }
    </script>
</body>

</html>
