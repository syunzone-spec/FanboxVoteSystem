<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€æ”¯æ´è€…é™å®šã€‘æŠ•ç¥¨æ‰€</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; color: #333; background: #fffaf0; }
        
        .top-link { margin-bottom: 20px; }
        .top-link a { color: #ff9900; text-decoration: none; font-weight: bold; border: 1px solid #ff9900; padding: 8px 15px; border-radius: 20px; background: white; }
        
        .login-box, .gacha-box, .list-box { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffcc00; }
        .hidden { display: none; }
        
        .status-badge { background: #ffcc00; color: #333; padding: 5px 10px; border-radius: 15px; font-weight: bold; display: inline-block; margin-bottom: 10px; }
        
        /* ã‚¬ãƒãƒ£æ¼”å‡º */
        .gacha-ball { width: 80px; height: 80px; line-height: 80px; border-radius: 50%; font-weight: bold; color: white; margin: 20px auto; font-size: 2em; box-shadow: 0 4px 10px rgba(0,0,0,0.3); animation: pop 0.5s ease-out; }
        .ball-SSR { background: gold; border: 4px solid orange; color: #a05a00; }
        .ball-SR { background: silver; border: 4px solid gray; color: #333; }
        .ball-R { background: #cd7f32; border: 4px solid #8b4513; color: white; }
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        input { padding: 10px; font-size: 1.2em; width: 80%; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #ff9900; color: white; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .candidate-card { border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .vote-btn { background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; }

        /* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ï¼ˆæ§ãˆã‚ã«é…ç½®ï¼‰ */
        .logout-link { display: block; margin-top: 10px; font-size: 0.8em; color: #999; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸ—³ï¸ æ”¯æ´è€…é™å®šæŠ•ç¥¨æ‰€</h2>
    
    <div class="top-link">
        <a href="result.html" target="_blank">ğŸ“Š ç¾åœ¨ã®é †ä½ã‚’ç¢ºèªã™ã‚‹</a>
    </div>

    <div id="login-section" class="login-box">
        <p>Fanboxæ”¯æ´è€…èªè¨¼</p>
        
        <input type="number" id="pixiv-id" placeholder="Pixiv ID (æ•°å­—)" style="margin-bottom:5px;">
        <br>
        
        <input type="text" id="pixiv-name" placeholder="Pixivãƒ¦ãƒ¼ã‚¶ãƒ¼å" style="margin-bottom:5px;">
        <br>
        
        <input type="text" id="monthly-pass" placeholder="ä»Šæœˆã®åˆè¨€è‘‰" style="margin-bottom:10px;">
        <br>
        
        <button id="check-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="loading-msg" class="hidden" style="margin-bottom:20px; color:#666;">
        èªè¨¼ä¸­...
    </div>

    <div id="vote-section" class="gacha-box hidden">
        <p>ğŸ—³ï¸ æŠ•ç¥¨æœŸé–“ï¼š2026å¹´1æœˆ20æ—¥ï½2026å¹´1æœˆ31æ—¥</p>
        <div class="status-badge">æ®‹ã‚ŠæŠ•ç¥¨å›æ•°: <span id="remain-count">0</span> / <span id="max-count">0</span></div>
        
        <p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ä»Šå›ã®ç¥¨æ•°ã‚’æ±ºå®šã—ã¾ã™ã€‚</p>
        <button id="pull-btn">æŠ½é¸é–‹å§‹</button>

        <div id="result-area" class="hidden">
            <div id="gacha-ball-display"></div>
            <p style="font-size:1.2em;">ä»Šå›ã¯ <strong><span id="current-weight" style="color:red; font-size:1.5em;"></span> ç¥¨</strong> ã¨ã—ã¦æŠ•ç¥¨ã§ãã¾ã™ï¼</p>
            <hr>
            <p>æŠ•ç¥¨å…ˆã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆãƒªã‚¹ãƒˆã¯ãƒ©ãƒ³ãƒ€ãƒ é †ï¼‰</p>
            <div id="candidates-list"></div>
        </div>

        <div class="logout-link" onclick="logout()">IDã‚’å¤‰æ›´ã™ã‚‹ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰</div>
    </div>

    <div id="done-section" class="list-box hidden">
        <h3>ğŸ‰ æŠ•ç¥¨å®Œäº† ğŸ‰</h3>
        <p>ä»Šå›ã®æŠ•ç¥¨æ¨©ã‚’ã™ã¹ã¦ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸï¼<br>ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼</p>
        <button onclick="location.href='result.html'">çµæœã‚’è¦‹ã‚‹</button>
        
        <div class="logout-link" onclick="logout()">IDã‚’å¤‰æ›´ã™ã‚‹ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰</div>
    </div>

    <script>
        // â˜…GAS URLï¼ˆã”è‡ªèº«ã®ã‚‚ã®ã«æ›¸ãæ›ã‚ã£ã¦ã„ã‚‹å‰æã§ã™ï¼‰
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzNarCkSJAZ4EcFLzKJESySKByFFsa-pAk2fDLZ-twdbIuKaqhDlnHwSZ7bkIoX1BCy6A/exec";
        
        let currentUser = null;
        let candidatesData = [];

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        document.addEventListener('DOMContentLoaded', () => {
            const savedId = localStorage.getItem('supporter_pid');
            const savedName = localStorage.getItem('supporter_name');
            const savedPass = localStorage.getItem('supporter_pass');
            
            if(savedId && savedPass) {
                document.getElementById('pixiv-id').value = savedId;
                document.getElementById('monthly-pass').value = savedPass;
                if(savedName) document.getElementById('pixiv-name').value = savedName; 
                
                // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
                performLogin(savedId, savedPass, savedName);
            }
        });

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚
        document.getElementById('check-btn').addEventListener('click', () => {
            const pid = document.getElementById('pixiv-id').value;
            const name = document.getElementById('pixiv-name').value;
            const pass = document.getElementById('monthly-pass').value;
            
            if(!pid) return alert("Pixiv IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(!name) return alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(!pass) return alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            performLogin(pid, pass, name);
        });

        // â˜…ä¿®æ­£ç‚¹: å¼•æ•°ã‚’3ã¤(pid, pass, name)å—ã‘å–ã‚‹ã‚ˆã†ã«å¤‰æ›´
        async function performLogin(pid, pass, name) {
            const loginBox = document.getElementById('login-section');
            const loadingMsg = document.getElementById('loading-msg');
            const btn = document.getElementById('check-btn');

            loginBox.classList.add('hidden');
            loadingMsg.classList.remove('hidden');
            btn.disabled = true;

            try {
                // â˜…ä¿®æ­£ç‚¹: URLã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(&password=...)ã‚’å«ã‚ã¦é€ä¿¡
                const res = await fetch(`${GAS_API_URL}?pixiv_id=${pid}&password=${encodeURIComponent(pass)}`);
                const json = await res.json();
                
                loadingMsg.classList.add('hidden');

                if(json.status === 'success') {
                    // â˜…ä¿®æ­£ç‚¹: ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«3ç‚¹ã‚»ãƒƒãƒˆã‚’ä¿å­˜
                    localStorage.setItem('supporter_pid', pid);
                    localStorage.setItem('supporter_pass', pass);
                    if(name) localStorage.setItem('supporter_name', name);

                    currentUser = json.data.user;
                    candidatesData = json.data.candidates;
                    
                    if (currentUser.is_fully_voted) {
                        document.getElementById('done-section').classList.remove('hidden');
                    } else {
                        setupVoteScreen();
                    }
		} else if (json.status === 'maintenance') {
		   // ç”»é¢å…¨ä½“ã‚’ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¡¨ç¤ºã«æ›¸ãæ›ãˆ
		   document.body.innerHTML = `
		       <div style="text-align:center; padding:50px; font-family:sans-serif;">
		           <h2 style="color:#ffc107;">ğŸš§ MAINTENANCE</h2>
		           <p>${json.message.replace(/\n/g, '<br>')}</p>
		       </div>`;
		   return;
		} else {
                    alert(json.message); // ã€Œåˆè¨€è‘‰ãŒé•ã„ã¾ã™ã€ãªã©ãŒè¡¨ç¤ºã•ã‚Œã‚‹
                    loginBox.classList.remove('hidden');
                    btn.disabled = false;
                    localStorage.removeItem('supporter_pid'); 
                    localStorage.removeItem('supporter_pass'); 
                }
            } catch(e) {
                console.error(e);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                loadingMsg.classList.add('hidden');
                loginBox.classList.remove('hidden');
                btn.disabled = false;
            }
        }

        function setupVoteScreen() {
            const remain = currentUser.max_votes - currentUser.vote_count;
            document.getElementById('remain-count').innerText = remain;
            document.getElementById('max-count').innerText = currentUser.max_votes;
            document.getElementById('vote-section').classList.remove('hidden');
            
            document.getElementById('pull-btn').onclick = () => {
                playGacha(currentUser.next_gacha);
            };
        }

        function playGacha(result) {
            document.getElementById('pull-btn').classList.add('hidden'); 
            const area = document.getElementById('result-area');
            area.classList.remove('hidden');
            
            const ball = document.getElementById('gacha-ball-display');
            ball.className = `gacha-ball ball-${result.rank}`;
            ball.innerText = result.rank;
            
            document.getElementById('current-weight').innerText = result.weight;

            const shuffled = shuffleArray([...candidatesData]);
            renderList(shuffled, result.weight);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderList(list, weight) {
            const container = document.getElementById('candidates-list');
            container.innerHTML = "";
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'candidate-card';
                div.innerHTML = `
                    <div style="text-align:left;"><strong>${item.character}</strong><br><small>${item.theme}</small></div>
                    <button class="vote-btn" onclick="submitVote('${item.id}', '${item.character}', ${weight})">æŠ•ç¥¨</button>
                `;
                container.appendChild(div);
            });
        }

        async function submitVote(targetId, charName, weight) {
            if(!confirm(`ã€Œ${charName}ã€ã« ${weight}ç¥¨ ã‚’æŠ•ç¥¨ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            
            const allBtns = document.querySelectorAll('.vote-btn');
            allBtns.forEach(b => b.disabled = true);

            try {
                // â˜…ä¿®æ­£ç‚¹: ä¿å­˜ã•ã‚ŒãŸåå‰ã‚’å‘¼ã³å‡ºã—ã¦é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
                const storedName = localStorage.getItem('supporter_name') || 'åç„¡ã—';

                const payload = {
                    action: 'submit_vote_supporter',
                    pixiv_id: currentUser.pixiv_id,
                    user_name: storedName, // ã“ã“ã§é€ä¿¡
                    target_request_id: targetId,
                    total_weight: weight,
                    ip_address: await getIp(),
                    user_agent: navigator.userAgent,
		    device_uuid: getUUID()
                };
                
                const res = await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                
                if(json.status === 'success') {
                    alert("æŠ•ç¥¨å®Œäº†ï¼\n(æ¬¡ã®æŠ•ç¥¨ã¸é€²ã¿ã¾ã™)");
                    location.reload(); 
                } else {
                    alert(json.message);
                    location.reload();
                }
            } catch(e) { 
                alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); 
                location.reload(); 
            }
        }
        
        async function getIp() { try { const r = await fetch('https://api.ipify.org?format=json'); return (await r.json()).ip; } catch { return ''; } }

        function logout() {
            if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆæ¬¡å›IDå…¥åŠ›ãŒå¿…è¦ã«ãªã‚Šã¾ã™ï¼‰")) {
                localStorage.removeItem('supporter_pid');
                localStorage.removeItem('supporter_pass');
                localStorage.removeItem('supporter_name');
                location.reload();
            }
        }

	function getUUID() {
            let u = localStorage.getItem('g_uuid');
            if(!u) { 
                // UUIDæœªç”Ÿæˆãªã‚‰æ–°è¦ä½œæˆã—ã¦ä¿å­˜
                u = crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx'.replace(/[xy]/g, c => {var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});
                localStorage.setItem('g_uuid', u); 
            }
            return u;
        }
    </script>
</body>
</html>
